# 目录
- [iOS 屏幕共享功能的技术文档](#ios-屏幕共享功能的技术文档)
  * [0. 概述](#0-概述)
  * [1. 如何在 USB 层面启用 iOS 设备](#1-如何在-usb-层面启用-ios-设备)
    + [1.1 基础](#11-基础)
    + [1.2 使用 LibUsb 查找设备和配置](#12-使用-libusb-查找设备和配置)
    + [1.3 隐藏配置](#13-隐藏配置)
    + [1.4 启用隐藏配置](#14-启用隐藏配置)
  * [2. AV 会话生命周期](#2-av-会话生命周期)
    + [2.1 启动会话](#21-启动会话)
    + [2.2 接收数据](#22-接收数据)
    + [2.3 关闭流媒体](#23-关闭流媒体)
  * [3. 协议参考](#3-协议参考)
    + [3.1 Ping 包](#31-ping-包)
    + [3.2 同步包](#32-同步包)
      - [3.2.1 概述](#321-概述)
      - [3.2.2 CWPA 包和响应](#322-cwpa-包和响应)
        * [概述](#概述)
        * [请求格式描述](#请求格式描述)
        * [回复 - RPLY 格式描述](#回复---rply-格式描述)
      - [3.2.3 AFMT 包](#323-afmt-包)
        * [概述](#概述-1)
        * [请求格式描述](#请求格式描述-1)
        * [回复 - RPLY 格式描述](#回复---rply-格式描述-1)
      - [3.2.4 CVRP 包](#324-cvrp-包)
        * [概述](#概述-2)
        * [请求格式描述](#请求格式描述-2)
        * [回复 - RPLY 格式描述](#回复---rply-格式描述-2)
      - [3.2.5 CLOK 包](#325-clok-包)
        * [概述](#概述-3)
        * [请求格式描述](#请求格式描述-3)
        * [回复 - RPLY 格式描述](#回复---rply-格式描述-3)
      - [3.2.6 TIME 包](#326-time-包)
        * [概述](#概述-4)
        * [请求格式描述](#请求格式描述-4)
        * [回复 - RPLY 格式描述](#回复---rply-格式描述-4)
      - [3.2.7 SKEW 包](#327-skew-包)
        * [概述](#概述-5)
        * [请求格式描述](#请求格式描述-5)
        * [回复 - RPLY 格式描述](#回复---rply-格式描述-5)
      - [3.2.8 OG 包](#328-og-包)
        * [概述](#概述-6)
        * [请求格式描述](#请求格式描述-6)
        * [回复 - RPLY 格式描述](#回复---rply-格式描述-6)
      - [3.2.9 STOP 包](#329-stop-包)
        * [概述](#概述-7)
        * [请求格式描述](#请求格式描述-7)
        * [回复 - RPLY 格式描述](#回复---rply-格式描述-7)
    + [3.3 异步包](#33-异步包)
        * [3.3.0 概述](#330-概述)
        * [3.3.1 异步 SPRP - 设置属性](#331-异步-sprp---设置属性)
          + [概述](#概述-8)
          + [包格式描述](#包格式描述)
        * [3.3.2 异步 SRAT - 设置时间速率和锚点](#332-异步-srat---设置时间速率和锚点)
          + [概述](#概述-9)
          + [包格式描述](#包格式描述-1)
        * [3.3.3 异步 TBAS - 设置时间基准](#333-异步-tbas---设置时间基准)
          + [概述](#概述-10)
          + [包格式描述](#包格式描述-2)
        * [3.3.4 异步 TJMP - 时间跳跃通知](#334-异步-tjmp---时间跳跃通知)
          + [概述](#概述-11)
          + [包格式描述](#包格式描述-3)
        * [3.3.5 异步 FEED - 包含 h264 视频数据的 CMSampleBuffer](#335-异步-feed---包含-h264-视频数据的-cmsamplebuffer)
          + [包格式描述](#包格式描述-4)
        * [3.3.6 异步 EAT! - 包含音频数据的 CMSampleBuffer](#336-异步-eat----包含音频数据的-cmsamplebuffer)
        * [3.3.7 异步 NEED - 告诉设备发送更多数据](#337-异步-need---告诉设备发送更多数据)
          + [包格式描述](#包格式描述-5)
        * [3.3.8 异步 HPD0 - 告诉设备停止视频流](#338-异步-hpd0---告诉设备停止视频流)
          + [包格式描述](#包格式描述-6)
        * [3.3.9 异步 HPA0 - 告诉设备停止音频流](#339-异步-hpa0---告诉设备停止音频流)
          + [包格式描述](#包格式描述-7)
        * [3.3.10 异步 RELS - 告诉我们设备上释放的时钟](#3310-异步-rels---告诉我们设备上释放的时钟)
          + [包格式描述](#包格式描述-8)
  * [4. 序列化/反序列化对象](#4-序列化反序列化对象)
    + [4.0 概述](#40-概述)
    + [4.1 字典](#41-字典)
      - [4.1.0 概述](#410-概述)
      - [4.1.1 字符串键的字典](#411-字符串键的字典)
        * [4.1.1.1 字典的通用结构](#4111-字典的通用结构)
      - [4.1.2 4 字节整数索引键的字典](#412-4-字节整数索引键的字典)
    + [4.2 CMTime](#42-cmtime)
      - [示例](#示例)
    + [4.3 CMSampleBuffer](#43-cmsamplebuffer)
    + [4.4 NSNumber](#44-nsnumber)
      - [示例](#示例-1)
    + [4.5 CMFormatDescription](#45-cmformatdescription)
  * [5. 时钟和 CMSync](#5-时钟和-cmsync)

<small><i><a href='http://ecotrust-canada.github.io/markdown-toc/'>目录由 markdown-toc 生成</a></i></small>

# iOS 屏幕共享功能的技术文档
## 0. 概述
本文档提供了有关 QuickTime iOS 设备屏幕共享功能的详细信息。本文档中的信息可用于在选择的编程语言中重新实现该功能，并在非 Mac OS X 操作系统上使用该功能。如果您想实现该功能，我建议使用我的单元测试和测试夹具。我已经准备了一个包含每种消息类型示例的二进制转储。这样，您可以轻松确保您的编解码器按预期工作。仓库还包含一个 Golang 的参考实现。

-- 注意：本文档中的所有信息均由作者逆向工程，因此可能存在错误或不完全准确，因为涉及很多假设。如果您发现错误或更准确的描述，请添加它们 :-) --

## 1. 如何在 USB 层面启用 iOS 设备
### 1.1 基础
通常，连接到 USB 端口的设备具有一组“配置”，您可以使用所使用的 LibUsb 包装器检索这些配置。在这些接口内部，有一组 USB 端点，您可以用来与设备通信。我们对 iOS 设备的 `bulk` 端点感兴趣，因为这些端点用于传输数据。
### 1.2 使用 LibUsb 查找设备和配置
查找具有 `DeviceClass = 0xFF` 接口的 USB 配置描述符。默认情况下，iOS 设备只有 USBMux 配置描述符，其子类为 `0xFE`，并且将包含一个具有两个 Bulk 端点的接口。允许 AV 流的配置的子类为 `0x2A`，并且将有一个具有 4 个 Bulk 端点的接口。需要先启用它。

### 1.3 隐藏配置
要使用视频镜像，您必须启用隐藏的 QuickTime 配置（我称之为 QT-Config，不是官方的苹果名称）。如果您密切监视所有可用的 USB 配置，您会发现如果设备有 n 个配置，当您在 Mac 上打开 QuickTime 并开始录制 iOS 设备的屏幕时，将会有 n+1 个配置。
### 1.4 启用隐藏配置
要启用隐藏的 QT 配置，您必须向设备发送特定的控制请求，如下所示：
`val, err := device.usbDevice.Control(0x40, 0x52, 0x00, 0x02, response)`
如果操作正确，它将导致设备从主机断开连接，并在几秒钟后重新连接，带有一个额外的配置。新配置包含 4 个 Bulk 端点。2 个用于与设备上的 usbmuxd 通信，另外两个用于接收和发送 AV 数据。调用 setActiveConfiguration 在该配置上，您可以声明新的端点用于发送和接收 AV 数据。
## 2. AV 会话生命周期

### 2.1 启动会话
1. 启用隐藏设备配置
2. 声明端点
3. 等待接收 PING 包
4. 响应 PING 包
5. 等待 SYNC CWPA 包以接收设备音频时钟的 clockref
6. 创建本地时钟，将 clockref 放入对 SYNC CWPA 的回复中并发送
7. 发送 ASYN_HPD1
8. 发送 ASYN_HPA1，包含在步骤 6 中接收到的设备音频时钟参考
9. 接收 SYNC AFMT 并回复零错误代码
10. 接收 SYNC CVRP，包含设备的视频时钟参考
11. 回复本地视频时钟参考
12. 开始发送 ASYN NEED，包含设备的视频时钟参考
13. 接收两个 ASYN 设置属性
14. 接收 Sync Clok 并回复新创建的时钟
15. 接收两个 SYNC TIME 并回复两个 CMTime
### 2.2 接收数据
设备将发送视频和音频的 FEED 和 EAT! 包。我们需要定期发送 NEED 包以获取视频。

### 2.3 关闭流媒体
1. 发送 asyn hpa0，包含来自 cwpa sync 包的设备时钟参考，以告诉设备停止发送音频
2. 发送 hpd0，包含空的时钟参考以停止视频
3. 接收 sync stop 包，包含我们在 cvrp 发送时创建的视频时钟，并且在每个 feed 包中都有
4. 回复 sync stop，包含 8 个零字节
5. 接收 ASYN RELS，包含本地视频时钟参考（在 FEED 包中找到的那个）
6. 接收 ASYN RELS，包含在 SYNC CLOCK 之后创建的本地时钟
7. 释放 USB 端点
8. 将设备的活动配置设置为仅 USBMux

## 3. 协议参考
### 3.1 Ping 包
一旦我们连接到 USB 端点，我们需要等待设备发送一个 ping 包。一旦我们收到它，我们将发送一个 ping 回设备，然后继续进行其余的通信。示例 Ping：

| 4 字节长度 (16)   |4 字节 Magic (PING)   | 4 字节 0x0| 4 字节 0x1   | 
|---|---|---|---|
|10000000 |676E6970 | 00000000 | 01000000 |
  

### 3.2 同步包
#### 3.2.1 概述
所有 SYNC 包都需要我们回复一个 RPLY 包。看起来这主要用于同步 CMClocks 和交换 8 字节 CMClockRefs（实现 CMSync.h 协议）。通常，您可以看到 SYNC 包具有 4 字节子类型，后跟 8 字节相关 ID。回复总是包含相关 ID，因此我认为这是设备知道哪个回复属于哪个请求的方式。

#### 3.2.2 CWPA 包和响应
##### 概述
此包似乎用于启动音频流。我们从设备获取一个时钟参考并回复我们自己的新创建的时钟参考。设备发送的时钟参考需要放入我们发送的 ASYN-1APH 包中。
##### 请求格式描述

| 4 字节长度 (36)   |4 字节 Magic (SYNC)   | 8 字节空时钟参考| 4 字节消息类型 (CWPA)   | 8 字节相关 ID  | 8 字节设备时钟的 CFTypeID |
|---|---|---|---|---|---|
|24000000 |636E7973 |01000000 00000000 | 61707763 |E03D5713 01000000| E0740000 5A130040 |

##### 回复 - RPLY 格式描述

发送回我们的时钟参考。设备将在 SYNC_AFMT 消息中使用此处的时钟参考告诉我们音频格式。此外，这将用于所有包含音频样本缓冲区的 ASYN_EAT 包。

| 4 字节长度 (28)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |   4 字节: 0  | 8 字节我们的时钟的 CFTypeID |
|---|---|---|---|---|
|1C000000 | 796C7072 |E03D5713 01000000 | 00000000 |B00CE26C A67F0000|

#### 3.2.3 AFMT 包
##### 概述
此包包含有关音频格式 (AMFT) 的信息。它包含一个 AudioStreamBasicDescription 结构 [参见此处](https://github.com/nu774/MSResampler/blob/master/CoreAudio/CoreAudioTypes.h)。通常是线性脉冲编码调制 (LPCM) 的 MediaID，这意味着未压缩的音频。回复基本上是一个包含错误代码的字典。通常我们发送 0 表示一切正常。注意设备如何引用我们在 SYNC_CWPA_RPLY 中给出的时钟。
##### 请求格式描述

| 4 字节长度 (68)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID| 4 字节 Magic (AFMT)| 8 字节相关 ID| AudioStreamBasicDescription 结构：float64 采样频率 (48khz)，数据 4 字节 Magic (LPCM)，28 字节其余部分|
|---|---|---|---|---|---|
|44000000| 636E7973| B00CE26C A67F0000| 746D6661 | 809D2213 01000000| 00000000 0070E740 6D63706C 4C000000 04000000 01000000 04000000 02000000 10000000 00000000|

##### 回复 - RPLY 格式描述
包含请求中的相关 ID 以及一个简单的字典：{"Error":NSNumberUint32(0)}

| 4 字节长度 (62)   |4 字节 Magic (RPLY)   | 8 字节相关 ID| 4 字节 0| 4 字节字典长度(42)| 4 字节 Magic (DICT)| 字典字节 |
|---|---|---|---|---|---|---|
|3E000000 |796C7072| 809D2213 01000000 |00000000| 2A000000| 74636964| 22000000 7679656B 0D000000 6B727473 4572726F 720D0000 0076626D 6E030000 0000|

#### 3.2.4 CVRP 包
##### 概述
CVRP 包用于创建本地时钟以同步视频帧。我们从设备获取的时钟参考是我们需要放入 NEED 包中的参考。类似地，设备发送的所有 ASYN_FEED 样本缓冲区都引用我们的时钟。在此之后，通常会收到两个 SetProperty 异步包以及 Clok、TBAS 和 SRAT。
##### 请求格式描述

包含一个带有 FormatDescription 和时间信息的字典。通过 FormatDescription，我们第一次获得了 h264 图片和序列参数集 (PPS/SPS)，它们已经编码成漂亮的 NALUs，准备好用于网络流媒体。它们隐藏在扩展字典中的字典中。

|4 字节长度 (649)|4 字节 Magic (SYNC)|8 字节空(?) 时钟参考|4 字节 Magic (CVRP)|8 字节相关 ID|设备上的时钟 CFTypeID（需要放入我们发送的 NEED 包中）|4 字节字典长度 (613)|4 字节 Magic (DICT)| 字典字节|
|---|---|---|---|---|---|---|---|---|
|89020000 |636E7973| 01000000 00000000 |70727663| D0595613 01000000 |A08D5313 01000000 |65020000| 74636964| 0x.....|

##### 回复 - RPLY 格式描述

| 4 字节长度 (28)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  4 字节（似乎总是 0） | 8 字节我们的时钟的 CFTypeID（将出现在所有 feed 异步包中） |
|---|---|---|---|---|
|1C000000 | 796C7072 |D0595613 01000000 | 00000000 |5002D16C A67F0000 |

#### 3.2.5 CLOK 包
##### 概述
此请求我们创建一个新时钟并发送回时钟参考。通常会跟随两个 TIME 请求。

##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (CLOK) | 8 字节相关 ID |
|---|---|---|---|---|
|1C000000| 636E7973| 5002D16C A67F0000| 6B6F6C63 | 70495813 01000000 |

##### 回复 - RPLY 格式描述

| 4 字节长度 (28)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  4 字节（似乎总是 0） | 8 字节我们的时钟的 CFTypeID（用于接下来的两个 TIME 包） |
|---|---|---|---|---|
|1C000000| 796C7072| 70495813 01000000| 00000000 | 8079C17C A67F0000|

#### 3.2.6 TIME 包
##### 概述
此包请求我们发送一个包含指定时钟参考的当前 CMTime 的 RPLY 包。
##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (TIME) | 8 字节相关 ID |
|---|---|---|---|---|
|1C000000| 636E7973| 8079C17C A67F0000 |656D6974 | 503D2213 01000000 |

##### 回复 - RPLY 格式描述

| 4 字节长度 (44)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  4 字节 0x0 | 24 字节 CMTime 结构 |
|---|---|---|---|---|
|2C000000 |796C7072 |503D2213 01000000| 00000000 | E1E142C4 62BA0000 00CA9A3B 01000000 00000000 00000000|

#### 3.2.7 SKEW 包
##### 概述
此包告诉设备音频时钟的时钟偏移（在 EAT! 包中使用的时钟参考，我们在 cwpa 响应中发送）。如 [维基百科](https://en.wikipedia.org/wiki/Clock_skew#On_a_network) 文章所述，时钟偏移意味着两个时钟的频率差异。换句话说，两个时钟应该都运行在 48khz，设备想知道在设备时钟有一个滴答期间我们的时钟执行了多少滴答。
所以我们必须回复：
- 如果时钟对齐，则为 48000
- 如果我们的时钟较慢，则为 48000 以上的某个值
- 如果我们的时钟比设备时钟快，则为 48000 以下的某个值
如果实现正确，我们应该看到偏移响应趋向于 48000，有时会有小的偏差 `(48000+x，其中 -1 < x <1)`

##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (SKEW) | 8 字节相关 ID | 
|---|---|---|---|---|
|20000000| 636E7973| 8079C17C A67F0000 |77656B73 | 60B9FD02 01000000 | 

##### 回复 - RPLY 格式描述

| 4 字节长度 (24)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  | 4 字节填充 0x0| 8 字节浮点数 (48000.0) | 
|---|---|---|---|---|
|18000000 |796C7072 |60B9FD02 01000000| 00000000 | 00000000 0070E740 |

#### 3.2.8 OG 包
##### 概述
我不知道这是什么或它的用途。似乎它发送一个总是等于 1 的 uint32 作为负载，我们必须回复一个 8 字节的零。
##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (OG!.) | 8 字节相关 ID | 4 字节未知整数|
|---|---|---|---|---|---|
|20000000| 636E7973| 8079C17C A67F0000 |20216F67 | 302FD302 01000000 | 01000000 |

##### 回复 - RPLY 格式描述

| 4 字节长度 (24)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  8 字节 0x0 | 
|---|---|---|---|
|18000000 |796C7072 |302FD302 01000000| 00000000 00000000|

#### 3.2.9 STOP 包
##### 概述
此包告诉我们停止我们的时钟。
##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (STOP) | 8 字节相关 ID | 
|---|---|---|---|---|
|1C000000| 636E7973| F05F4235 BA7F0000 | 706F7473 | 1049FD02 01000000 | 

##### 回复 - RPLY 格式描述

| 4 字节长度 (24)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  4 字节 0x0 | 4 字节 0x0 |
|---|---|---|---|---|
|18000000 |796C7072 |1049FD02 01000000| 00000000 | 00000000|

### 3.3 异步包
##### 3.3.0 概述
异步包包含 CMFormatDescriptions、属性和最重要的 CMSampleBuffers，包含音频和视频数据。
它们以 4 字节长度、4 字节 Magic 和 8 字节时钟参考开始。
异步包不需要我们响应或确认。
##### 3.3.1 异步 SPRP - 设置属性
###### 概述
此包用于设置视频流的属性。通常您只会收到两个包含一对引用视频流的属性。
1. ObeyEmptyMediaMarkers = true
2. RenderEmptyMedia = false

###### 包格式描述

| 4 字节长度 (变化)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (SPRP) | 键值对字节|
|---|---|---|---|---|
|20000000| 6E797361| 18BC2311 01000000 |70727073 | 00..... |

##### 3.3.2 异步 SRAT - 设置时间速率和锚点
###### 概述
我认为这个包与 TJMP、TBAS 和 CLOK 是某种时钟同步算法的一部分。
我相信它与 AVPlayer.SetRate 通常做的事情有关。
它也可能告诉我们在我们的时钟上调用这个：CMTimebaseSetRateAndAnchorTime https://developer.apple.com/documentation/coremedia/cmtimebase?language=objc

###### 包格式描述

| 4 字节长度 (49)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (SRAT) | 32 位浮点数 (1.0)| 32 位浮点数 (1.0)| 24 字节 CMTime|
|---|---|---|---|---|---|---|
|31000000| 6E797361| 18BC2311 01000000 |74617273 | 0000803F | 0000803F| CB448EA1 CF10CC15 00CA9A3B 01000000 00000000 00000000|

##### 3.3.3 异步 TBAS - 设置时间基准
###### 概述
此包包含一个时钟参考和另一个我不知道的时钟参考。可能是我们应该为我们的时钟创建一个 CMTimeBase，使用给定的参考。也可能是设备创建了一个 CMTimeBase 并告诉我们。
到目前为止，我在整个通信中找不到另一个使用未知时钟/时间基准参考的地方。

###### 包格式描述

| 4 字节长度 (24)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (TBAS) | 8 字节未知时钟参考|
|---|---|---|---|---|
|18000000| 6E797361| 18BC2311 01000000 |73616274 | C0904402 01000000|

##### 3.3.4 异步 TJMP - 时间跳跃通知
###### 概述
我认为此包告诉我们设备上的 CMTimeBase 被设置为不同的时间。
由于这在其他地方没有引用或使用，我不确切知道它的含义或值的用途。

负载为 56 字节。我认为它可能是：4 字节整数 0x0，4 字节 0x0，CMTime，CMTime，但我不确定。
###### 包格式描述

| 4 字节长度 (72)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (TJMP) | 72 字节未知|
|---|---|---|---|---|
|48000000| 6E797361| 18BC2311 01000000 |706D6A74 | C0904402 01000000| 72 字节未知|

##### 3.3.5 异步 FEED - 带有 h264 视频数据的 CMSampleBuffer
对于视频数据异步 FEED 包，设备将使用我们在 CVRP 同步请求的回复中发送的时钟参考。
###### 包格式描述

| 4 字节长度 (变化，示例中为 91607)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (FEED) | 4 字节 CMSampleBuf 长度（变化，此处为 91587）| CMSampleBuf Magic (sbuf) | CMSampleBuf 字节|
|---|---|---|---|---|---|---|
|D7650100| 6E797361| 18BC2311 01000000 |64656566 | C3650100 | 66756273 | ... |

##### 3.3.6 异步 EAT! - 带有音频数据的 CMSampleBuffer
与 FEED 类似，只是 Magic 不同（0x21746165）和包含音频的 CMSampleBuf。

##### 3.3.7 异步 NEED - 告诉设备发送更多数据
为了告诉设备继续发送视频数据异步 FEED 包，我们需要发送 NEED 包，包含设备在 CVRP 同步包中给我们的时钟参考。
NEED 包在整个会话中是恒定的，所以一旦收到正确的时钟参考，您可以初始化它们，然后只需重复发送相同的字节。
我认为发送 NEED 包是可以基于计时器的（例如每 5 秒）。
为了更容易实现，我只在收到 FEED 时发送一个。
###### 包格式描述

| 4 字节长度 (20)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (NEED) |
|---|---|---|---|
|14000000| 6E797361| A08D5313 01000000 |6465656E | 

##### 3.3.8 异步 HPD0 - 告诉设备停止视频流
发送此包以停止设备流视频。

###### 包格式描述

| 4 字节长度 (20)   |4 字节 Magic (ASYN)   | 8 字节空时钟 CFTypeID  |  4 字节 Magic (HPD0) |
|---|---|---|---|
|14000000| 6E797361| 01000000 00000000 |30617068 | 

##### 3.3.9 异步 HPA0 - 告诉设备停止音频流
发送此包以停止设备流音频。

###### 包格式描述

| 4 字节长度 (20)   |4 字节 Magic (ASYN)   | 8 字节设备音频时钟 CFTypeID  |  4 字节 Magic (HPA0) |
|---|---|---|---|
|14000000| 6E797361| 10FCC502 01000000 |30617068 | 

##### 3.3.10 异步 RELS - 告诉我们设备上释放的时钟
###### 包格式描述

| 4 字节长度 (20)   |4 字节 Magic (ASYN)   | 8 字节设备音频时钟 CFTypeID  |  4 字节 Magic (RELS) |
|---|---|---|---|
|14000000| 6E797361| 008A6035 BA7F0000 | 736C6572 | 

## 4. 序列化/反序列化对象
### 4.0 概述
本章解释了如何序列化和反序列化您将在各种 SYNC 和 ASYN 包中找到的所有必要的负载对象。
### 4.1 字典
#### 4.1.0 概述
字典在协议中广泛使用，因此非常重要 :-D
它们非常容易实现，但请注意有两种不同的类型。一些字典仅使用字符串作为键，其他字典仅使用整数或索引号作为键。
有时您会看到带有其他 Magic 标记或单个键值条目的字典，但它们始终以相同的方式工作。
#### 4.1.1 带字符串键的字典
##### 4.1.1.1 字典的通用结构

字典总是以长度整数、字典 Magic 开始，然后是若干键值对，每个键值对以长度字段和键值 Magic 开始。
每个条目都有一个键，以 4 字节整数键长度开始，然后是字符串键 Magic。最后是包含实际键的字符串。
值的工作方式相同，它们以长度开始，然后是 Magic 和实际值。
此示例包含一个布尔值的字符串键字典很好地说明了字典的工作原理。

| 4 字节长度 (40)   |4 字节 Magic (DICT)   | 4 字节第一个键值对的长度 |  4 字节第一个键值对的 Magic (KEYV) | 4 字节第一个键的长度(15)| 字符串键 Magic (strk)| 键字符串 (Valeria) | 4 字节值的长度(9)| 4 字节值类型 Magic (bulv==布尔值) | 值 (0x1 == true) |
|---|---|---|---|---|---|---|---|---|---|
|28000000| 74636964| 20000000 |7679656B | 0F000000|6B727473|56616C65 726961|09000000|766C7562| 01|

以下是我知道的值类型：

| Magic 小端| Magic 大端 | 描述 | 值示例 |
|---|---|---|---|
|vlub|bulv|布尔值|0x1 或 0x0|
|vrts|strv|字符串|BlaBla|
|vtad|datv|字节数组|0x010203|
|vbmn|nmbv|NSNumber|[4.4 NSNumber](#44-nsnumber)|
|tcid|dict|字符串或索引键字典| 见上文 |
|csdf|fdsc|CMFormatDescription|[4.5 CMFormatDescription](#45-cmformatdescription)|

#### 4.1.2 带 4 字节整数索引键的字典
它们的工作方式与字符串键字典相同，唯一的区别是所有键都是 4 字节整数，并且它们的 Magic 标记为 0x6B786469 (idxk)。
### 4NEED 包中）|4 字节字典长度 (613)|4 字节 Magic (DICT)| 字典字节|
|---|---|---|---|---|---|---|---|---|
|89020000 |636E7973| 01000000 00000000 |70727663| D0595613 01000000 |A08D5313 01000000 |65020000| 74636964| 0x.....|

##### 回复 - RPLY 格式描述

| 4 字节长度 (28)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  4 字节（似乎总是 0） | 8 字节我们的时钟的 CFTypeID（将出现在所有 feed 异步包中） |
|---|---|---|---|---|
|1C000000 | 796C7072 |D0595613 01000000 | 00000000 |5002D16C A67F0000 |

#### 3.2.5 CLOK 包
##### 概述
此请求我们创建一个新时钟并发送回时钟参考。通常会跟随两个 TIME 请求。

##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (CLOK) | 8 字节相关 ID |
|---|---|---|---|---|
|1C000000| 636E7973| 5002D16C A67F0000| 6B6F6C63 | 70495813 01000000 |

##### 回复 - RPLY 格式描述

| 4 字节长度 (28)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  4 字节（似乎总是 0） | 8 字节我们的时钟的 CFTypeID（用于接下来的两个 TIME 包） |
|---|---|---|---|---|
|1C000000| 796C7072| 70495813 01000000| 00000000 | 8079C17C A67F0000|

#### 3.2.6 TIME 包
##### 概述
此包请求我们发送一个包含指定时钟参考的当前 CMTime 的 RPLY 包。
##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (TIME) | 8 字节相关 ID |
|---|---|---|---|---|
|1C000000| 636E7973| 8079C17C A67F0000 |656D6974 | 503D2213 01000000 |

##### 回复 - RPLY 格式描述

| 4 字节长度 (44)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  4 字节 0x0 | 24 字节 CMTime 结构 |
|---|---|---|---|---|
|2C000000 |796C7072 |503D2213 01000000| 00000000 | E1E142C4 62BA0000 00CA9A3B 01000000 00000000 00000000|

#### 3.2.7 SKEW 包
##### 概述
此包告诉设备音频时钟的时钟偏移（在 EAT! 包中使用的时钟参考，我们在 cwpa 响应中发送）。如 [维基百科](https://en.wikipedia.org/wiki/Clock_skew#On_a_network) 文章所述，时钟偏移意味着两个时钟的频率差异。换句话说，两个时钟应该都运行在 48khz，设备想知道在设备时钟有一个滴答期间我们的时钟执行了多少滴答。
所以我们必须回复：
- 如果时钟对齐，则为 48000
- 如果我们的时钟较慢，则为 48000 以上的某个值
- 如果我们的时钟比设备时钟快，则为 48000 以下的某个值
如果实现正确，我们应该看到偏移响应趋向于 48000，有时会有小的偏差 `(48000+x，其中 -1 < x <1)`

##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (SKEW) | 8 字节相关 ID | 
|---|---|---|---|---|
|20000000| 636E7973| 8079C17C A67F0000 |77656B73 | 60B9FD02 01000000 | 

##### 回复 - RPLY 格式描述

| 4 字节长度 (24)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  | 4 字节填充 0x0| 8 字节浮点数 (48000.0) | 
|---|---|---|---|---|
|18000000 |796C7072 |60B9FD02 01000000| 00000000 | 00000000 0070E740 |

#### 3.2.8 OG 包
##### 概述
我不知道这是什么或它的用途。似乎它发送一个总是等于 1 的 uint32 作为负载，我们必须回复一个 8 字节的零。
##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (OG!.) | 8 字节相关 ID | 4 字节未知整数|
|---|---|---|---|---|---|
|20000000| 636E7973| 8079C17C A67F0000 |20216F67 | 302FD302 01000000 | 01000000 |

##### 回复 - RPLY 格式描述

| 4 字节长度 (24)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  8 字节 0x0 | 
|---|---|---|---|
|18000000 |796C7072 |302FD302 01000000| 00000000 00000000|

#### 3.2.9 STOP 包
##### 概述
此包告诉我们停止我们的时钟。
##### 请求格式描述

| 4 字节长度 (28)   |4 字节 Magic (SYNC)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (STOP) | 8 字节相关 ID | 
|---|---|---|---|---|
|1C000000| 636E7973| F05F4235 BA7F0000 | 706F7473 | 1049FD02 01000000 | 

##### 回复 - RPLY 格式描述

| 4 字节长度 (24)   |4 字节 Magic (RPLY)   | 8 字节相关 ID  |  4 字节 0x0 | 4 字节 0x0 |
|---|---|---|---|---|
|18000000 |796C7072 |1049FD02 01000000| 00000000 | 00000000|

### 3.3 异步包
##### 3.3.0 概述
异步包包含 CMFormatDescriptions、属性和最重要的 CMSampleBuffers，包含音频和视频数据。
它们以 4 字节长度、4 字节 Magic 和 8 字节时钟参考开始。
异步包不需要我们响应或确认。
##### 3.3.1 异步 SPRP - 设置属性
###### 概述
此包用于设置视频流的属性。通常您只会收到两个包含一对引用视频流的属性。
1. ObeyEmptyMediaMarkers = true
2. RenderEmptyMedia = false

###### 包格式描述

| 4 字节长度 (变化)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (SPRP) | 键值对字节|
|---|---|---|---|---|
|20000000| 6E797361| 18BC2311 01000000 |70727073 | 00..... |

##### 3.3.2 异步 SRAT - 设置时间速率和锚点
###### 概述
我认为这个包与 TJMP、TBAS 和 CLOK 是某种时钟同步算法的一部分。
我相信它与 AVPlayer.SetRate 通常做的事情有关。
它也可能告诉我们在我们的时钟上调用这个：CMTimebaseSetRateAndAnchorTime https://developer.apple.com/documentation/coremedia/cmtimebase?language=objc

###### 包格式描述

| 4 字节长度 (49)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (SRAT) | 32 位浮点数 (1.0)| 32 位浮点数 (1.0)| 24 字节 CMTime|
|---|---|---|---|---|---|---|
|31000000| 6E797361| 18BC2311 01000000 |74617273 | 0000803F | 0000803F| CB448EA1 CF10CC15 00CA9A3B 01000000 00000000 00000000|

##### 3.3.3 异步 TBAS - 设置时间基准
###### 概述
此包包含一个时钟参考和另一个我不知道的时钟参考。可能是我们应该为我们的时钟创建一个 CMTimeBase，使用给定的参考。也可能是设备创建了一个 CMTimeBase 并告诉我们。
到目前为止，我在整个通信中找不到另一个使用未知时钟/时间基准参考的地方。

###### 包格式描述

| 4 字节长度 (24)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (TBAS) | 8 字节未知时钟参考|
|---|---|---|---|---|
|18000000| 6E797361| 18BC2311 01000000 |73616274 | C0904402 01000000|

##### 3.3.4 异步 TJMP - 时间跳跃通知
###### 概述
我认为此包告诉我们设备上的 CMTimeBase 被设置为不同的时间。
由于这在其他地方没有引用或使用，我不确切知道它的含义或值的用途。

负载为 56 字节。我认为它可能是：4 字节整数 0x0，4 字节 0x0，CMTime，CMTime，但我不确定。
###### 包格式描述

| 4 字节长度 (72)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (TJMP) | 72 字节未知|
|---|---|---|---|---|
|48000000| 6E797361| 18BC2311 01000000 |706D6A74 | C0904402 01000000| 72 字节未知|

##### 3.3.5 异步 FEED - 带有 h264 视频数据的 CMSampleBuffer
对于视频数据异步 FEED 包，设备将使用我们在 CVRP 同步请求的回复中发送的时钟参考。
###### 包格式描述

| 4 字节长度 (变化，示例中为 91607)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (FEED) | 4 字节 CMSampleBuf 长度（变化，此处为 91587）| CMSampleBuf Magic (sbuf) | CMSampleBuf 字节|
|---|---|---|---|---|---|---|
|D7650100| 6E797361| 18BC2311 01000000 |64656566 | C3650100 | 66756273 | ... |

##### 3.3.6 异步 EAT! - 带有音频数据的 CMSampleBuffer
与 FEED 类似，只是 Magic 不同（0x21746165）和包含音频的 CMSampleBuf。

##### 3.3.7 异步 NEED - 告诉设备发送更多数据
为了告诉设备继续发送视频数据异步 FEED 包，我们需要发送 NEED 包，包含设备在 CVRP 同步包中给我们的时钟参考。
NEED 包在整个会话中是恒定的，所以一旦收到正确的时钟参考，您可以初始化它们，然后只需重复发送相同的字节。
我认为发送 NEED 包是可以基于计时器的（例如每 5 秒）。
为了更容易实现，我只在收到 FEED 时发送一个。
###### 包格式描述

| 4 字节长度 (20)   |4 字节 Magic (ASYN)   | 8 字节时钟 CFTypeID  |  4 字节 Magic (NEED) |
|---|---|---|---|
|14000000| 6E797361| A08D5313 01000000 |6465656E | 

##### 3.3.8 异步 HPD0 - 告诉设备停止视频流
发送此包以停止设备流视频。

###### 包格式描述

| 4 字节长度 (20)   |4 字节 Magic (ASYN)   | 8 字节空时钟 CFTypeID  |  4 字节 Magic (HPD0) |
|---|---|---|---|
|14000000| 6E797361| 01000000 00000000 |30647068 | 

##### 3.3.9 异步 HPA0 - 告诉设备停止音频流
发送此包以停止设备流音频。

###### 包格式描述

| 4 字节长度 (20)   |4 字节 Magic (ASYN)   | 8 字节设备音频时钟 CFTypeID  |  4 字节 Magic (HPA0) |
|---|---|---|---|
|14000000| 6E797361| 10FCC502 01000000 |30617068 | 

##### 3.3.10 异步 RELS - 告诉我们设备上释放的时钟
###### 包格式描述

| 4 字节长度 (20)   |4 字节 Magic (ASYN)   | 8 字节设备音频时钟 CFTypeID  |  4 字节 Magic (RELS) |
|---|---|---|---|
|14000000| 6E797361| 008A6035 BA7F0000 | 736C6572 | 

## 4. 序列化/反序列化对象
### 4.0 概述
本章解释了如何序列化和反序列化您将在各种 SYNC 和 ASYN 包中找到的所有必要的负载对象。
### 4.1 字典
#### 4.1.0 概述
字典在协议中广泛使用，因此非常重要 :-D
它们非常容易实现，但请注意有两种不同的类型。一些字典仅使用字符串作为键，其他字典仅使用整数或索引号作为键。
有时您会看到带有其他 Magic 标记或单个键值条目的字典，但它们始终以相同的方式工作。
#### 4.1.1 带字符串键的字典
##### 4.1.1.1 字典的通用结构

字典总是以长度整数、字典 Magic 开始，然后是若干键值对，每个键值对以长度字段和键值 Magic 开始。
每个条目都有一个键，以 4 字节整数键长度开始，然后是字符串键 Magic。最后是包含实际键的字符串。
值的工作方式相同，它们以长度开始，然后是 Magic 和实际值。
此示例包含一个布尔值的字符串键字典很好地说明了字典的工作原理。

| 4 字节长度 (40)   |4 字节 Magic (DICT)   | 4 字节第一个键值对的长度 |  4 字节第一个键值对的 Magic (KEYV) | 4 字节第一个键的长度(15)| 字符串键 Magic (strk)| 键字符串 (Valeria) | 4 字节值的长度(9)| 4 字节值类型 Magic (bulv==布尔值) | 值 (0x1 == true) |
|---|---|---|---|---|---|---|---|---|---|
|28000000| 74636964| 20000000 |7679656B | 0F000000|6B727473|56616C65 726961|09000000|766C7562| 01|

以下是我知道的值类型：

| Magic 小端| Magic 大端 | 描述 | 值示例 |
|---|---|---|---|
|vlub|bulv|布尔值|0x1 或 0x0|
|vrts|strv|字符串|BlaBla|
|vtad|datv|字节数组|0x010203|
|vbmn|nmbv|NSNumber|[4.4 NSNumber](#44-nsnumber)|
|tcid|dict|字符串或索引键字典| 见上文 |
|csdf|fdsc|CMFormatDescription|[4.5 CMFormatDescription](#45-cmformatdescription)|

#### 4.1.2 带 4 字节整数索引键的字典
它们的工作方式与字符串键字典相同，唯一的区别是所有键都是 4 字节整数，并且它们的 Magic 标记为 0x6B786469 (idxk)。
### 4.2 CMTime
这与 CMTime.h 中的内容完全相同 https://github.com/phracker/MacOSX-SDKs/blob/master/MacOSX10.8.sdk/System/Library/Frameworks/CoreMedia.framework/Versions/A/Headers/CMTime.h
有很多文档，所以请查看 :-D

#### Example
|CMTimeValue  |CMTimeScale (默认是纳秒)   | CMTimeFlags |  CMTimeEpoch |
|---|---|---|---|
|CB448EA1 CF10CC15| 00CA9A3B| 01000000 |00000000 00000000 | 


### 4.3 CMSampleBuffer
### 4.4 NSNumber
一个非常简单的 NSNumber 表示。
我见过三种不同的类型：
- 类型 3, 32 位整数
- 类型 4, 64 位整数
- 类型 6, 64 位浮点数

#### 示例
|4 字节 Magic (nmbv)  |4 字节整数类型   | 数字，根据类型为 4 或 8 字节 |
|---|---|---|
|76626D6E | 03000000| 01000000 |



### 4.5 CMFormatDescription
请查看 https://github.com/phracker/MacOSX-SDKs/blob/master/MacOSX10.9.sdk/System/Library/Frameworks/CoreMedia.framework/Versions/A/Headers/CMFormatDescription.h


## 5. Clocks and CMSync
我认为 ASYN 和 SYNC 包中的引用是针对 CMClocks 的。因此，为了发送 CMTime 请求，我只使用单调时钟（不要使用挂钟时间）
来发送以纳秒为单位的时间差（Scale == 1000000000）。看起来效果很好 :-D